name: Security & Dependency Scanning

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # ==================== Backend Security ====================
      - name: 🔒 Audit backend dependencies
        working-directory: ./server
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../backend-audit.json || true

      - name: 📊 Backend audit summary
        run: |
          if [ -f backend-audit.json ]; then
            VULNERABILITIES=$(jq '.metadata.vulnerabilities' backend-audit.json 2>/dev/null || echo '{}')
            echo "### 🔒 Backend Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$VULNERABILITIES" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # ==================== Frontend Security ====================
      - name: 🔒 Audit frontend dependencies
        working-directory: ./client
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../frontend-audit.json || true

      - name: 📊 Frontend audit summary
        run: |
          if [ -f frontend-audit.json ]; then
            VULNERABILITIES=$(jq '.metadata.vulnerabilities' frontend-audit.json 2>/dev/null || echo '{}')
            echo "### 🔒 Frontend Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$VULNERABILITIES" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # ==================== Secret Scanning ====================
      - name: 🔍 Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      # ==================== Summary ====================
      - name: ✅ Security scan summary
        if: always()
        run: |
          echo "## 🔒 Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scans performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Backend dependency audit" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Frontend dependency audit" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secret scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
